<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø³ÛŒØ³ØªÙ… ØªØ·Ø¨ÛŒÙ‚ ÙÛŒØ´â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù†Ú©ÛŒ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;900&display=swap"
    rel="stylesheet" />

  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg: #f8fafc;
      --bg2: #ffffff;
      --bg3: #f1f5f9;
      --border: #e2e8f0;
      --accent: #4f46e5;
      --accent2: #6366f1;
      --success: #16a34a;
      --danger: #dc2626;
      --text: #0f172a;
      --text2: #475569;
      --radius: 14px;
    }

    body {
      font-family: 'Vazirmatn', Tahoma, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      direction: rtl;
    }

    header {
      background: #ffffff;
      padding: 28px 32px;
      display: flex;
      align-items: center;
      gap: 16px;
      border-bottom: 1px solid var(--border);
      position: relative;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    header .logo {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #6366f1, #818cf8);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      flex-shrink: 0;
      box-shadow: 0 4px 14px rgba(99, 102, 241, .2);
      color: white;
    }

    header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text);
    }

    header p {
      font-size: .88rem;
      color: var(--text2);
      margin-top: 2px;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 32px 20px;
    }

    .upload-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 24px;
    }

    @media(max-width: 640px) {
      .upload-grid {
        grid-template-columns: 1fr;
      }
    }

    .upload-card {
      background: var(--bg2);
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      padding: 28px 20px;
      text-align: center;
      cursor: pointer;
      transition: border-color .25s, background .25s, transform .15s;
      position: relative;
    }

    .upload-card:hover {
      border-color: var(--accent2);
      background: var(--bg3);
      transform: translateY(-2px);
    }

    .upload-card.loaded {
      border-style: solid;
      border-color: var(--success);
      background: rgba(34, 197, 94, .07);
    }

    .upload-card input[type=file] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
      width: 100%;
      height: 100%;
    }

    .upload-card .icon {
      font-size: 40px;
      margin-bottom: 10px;
    }

    .upload-card h3 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .upload-card p {
      font-size: .82rem;
      color: var(--text2);
    }

    .upload-card .badge {
      display: inline-block;
      margin-top: 10px;
      background: rgba(99, 102, 241, .15);
      color: var(--accent2);
      border: 1px solid rgba(99, 102, 241, .3);
      border-radius: 20px;
      padding: 2px 12px;
      font-size: .78rem;
    }

    .upload-card.loaded .badge {
      background: rgba(34, 197, 94, .15);
      color: #4ade80;
      border-color: rgba(34, 197, 94, .3);
    }

    .file-name {
      font-size: .8rem;
      color: #4ade80;
      margin-top: 8px;
      word-break: break-all;
    }

    .options-bar {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px 22px;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 24px;
    }

    .options-bar label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: .88rem;
      cursor: pointer;
      user-select: none;
    }

    .options-bar input[type=checkbox] {
      width: 17px;
      height: 17px;
      accent-color: var(--accent);
      cursor: pointer;
    }

    .options-bar .sep {
      width: 1px;
      height: 30px;
      background: var(--border);
    }

    .btn-check {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #4f46e5, #7c3aed);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      font-size: 1.05rem;
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
      transition: opacity .2s, transform .15s, box-shadow .2s;
      box-shadow: 0 4px 24px rgba(99, 102, 241, .35);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 28px;
    }

    .btn-check:hover:not(:disabled) {
      opacity: .92;
      transform: translateY(-1px);
      box-shadow: 0 6px 30px rgba(99, 102, 241, .5);
    }

    .btn-check:disabled {
      opacity: .45;
      cursor: not-allowed;
    }

    #loading {
      display: none;
      text-align: center;
      padding: 40px;
      color: var(--text2);
    }

    .spinner {
      width: 42px;
      height: 42px;
      border: 4px solid rgba(99, 102, 241, .2);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin .8s linear infinite;
      margin: 0 auto 14px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    #summary {
      display: none;
      margin-bottom: 24px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 14px;
    }

    .stat-card {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
      text-align: center;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);
    }

    .stat-card .num {
      font-size: 2rem;
      font-weight: 900;
      background: linear-gradient(135deg, #4f46e5, #6366f1);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .stat-card.green .num {
      background: linear-gradient(135deg, #16a34a, #22c55e);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .stat-card.yellow .num {
      background: linear-gradient(135deg, #d97706, #fbbf24);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .stat-card.red .num {
      background: linear-gradient(135deg, #dc2626, #ef4444);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .stat-card.purple .num {
      background: linear-gradient(135deg, #9333ea, #c084fc);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .stat-card .lbl {
      font-size: .82rem;
      color: var(--text2);
      margin-top: 4px;
    }

    #results {
      display: none;
    }

    .results-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .results-header h2 {
      font-size: 1.1rem;
      font-weight: 700;
    }

    .filter-tabs {
      display: flex;
      gap: 8px;
    }

    .filter-tabs button {
      padding: 6px 16px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: var(--bg2);
      color: var(--text2);
      font-family: inherit;
      font-size: .82rem;
      cursor: pointer;
      transition: all .2s;
    }

    .filter-tabs button.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    .table-wrap {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      overflow-x: auto;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: .84rem;
      min-width: 720px;
    }

    thead th {
      background: var(--bg3);
      padding: 13px 14px;
      text-align: right;
      font-weight: 600;
      color: var(--text2);
      font-size: .8rem;
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
    }

    tbody tr {
      border-bottom: 1px solid var(--border);
      transition: background .15s;
    }

    tbody tr:last-child {
      border-bottom: none;
    }

    tbody tr:hover {
      background: rgba(0, 0, 0, .02);
    }

    tbody td {
      padding: 12px 14px;
      vertical-align: middle;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: .78rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .status-badge.found {
      background: rgba(22, 163, 74, .1);
      color: #16a34a;
      border: 1px solid rgba(22, 163, 74, .2);
    }

    .status-badge.notfound {
      background: rgba(220, 38, 38, .1);
      color: #dc2626;
      border: 1px solid rgba(220, 38, 38, .2);
    }

    .match-type {
      font-size: .74rem;
      color: var(--text2);
      margin-top: 2px;
    }

    .amount {
      font-family: monospace;
      font-weight: 600;
      color: #5b21b6;
    }

    .tracking {
      font-family: monospace;
      font-size: .82rem;
    }

    .highlight {
      color: #d97706;
      font-weight: 700;
    }

    .export-bar {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 16px;
      flex-wrap: wrap;
    }

    .btn-export {
      padding: 9px 20px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--bg3);
      color: var(--text);
      font-family: inherit;
      font-size: .85rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 7px;
      transition: all .2s;
    }

    .btn-export:hover {
      border-color: var(--accent2);
      color: var(--accent2);
    }

    #log-section {
      display: none;
      margin-top: 20px;
    }

    #log-section summary {
      cursor: pointer;
      color: var(--text2);
      font-size: .83rem;
      padding: 8px 0;
    }

    #log-box {
      background: #f8fafc;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px;
      font-family: monospace;
      font-size: .78rem;
      color: #334155;
      max-height: 320px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
      margin-top: 8px;
    }

    .error-box {
      background: rgba(239, 68, 68, .1);
      border: 1px solid rgba(239, 68, 68, .3);
      border-radius: var(--radius);
      padding: 16px 20px;
      color: #f87171;
      display: none;
      margin-bottom: 20px;
    }

    .col-type {
      font-size: .72rem;
      padding: 2px 7px;
      border-radius: 8px;
      margin-right: 4px;
    }

    .col-credit {
      background: rgba(34, 197, 94, .15);
      color: #4ade80;
    }

    .col-debit {
      background: rgba(239, 68, 68, .12);
      color: #f87171;
    }
  </style>
</head>

<body>

  <header>
    <div class="logo">ğŸ¦</div>
    <div>
      <h1>Ø³ÛŒØ³ØªÙ… ØªØ·Ø¨ÛŒÙ‚ ÙÛŒØ´â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù†Ú©ÛŒ</h1>
      <p>Ù…Ù‚Ø§ÛŒØ³Ù‡ ØµÙˆØ±Øªâ€ŒØ­Ø³Ø§Ø¨ Ù…Ø´ØªØ±ÛŒ (PDF) Ø¨Ø§ Ù¾Ø±ÛŒÙ†Øª Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù†Ú©ÛŒ (Excel)</p>
    </div>
  </header>

  <div class="container">

    <div class="upload-grid">
      <div class="upload-card" id="pdf-card">
        <input type="file" id="pdf-file" accept=".pdf,.html,.htm" />
        <div class="icon">ğŸ“„</div>
        <h3>ØµÙˆØ±Øªâ€ŒØ­Ø³Ø§Ø¨ Ù…Ø´ØªØ±ÛŒ (PDF ÛŒØ§ HTML)</h3>
        <p>Ú¯Ø²Ø§Ø±Ø´ Ø­Ø³Ø§Ø¨ Ù…Ø´ØªØ±ÛŒ â€” ÙØ§ÛŒÙ„ HTML Ø¯Ù‚ÛŒÙ‚â€ŒØªØ± Ùˆ Ø¨Ù‡ØªØ± Ø§Ø³Øª (ÛŒØ§ PDF Ø§Ø² Ù†Ø±Ù…â€ŒØ§ÙØ²Ø§Ø±)</p>
        <span class="badge" id="pdf-badge">Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡</span>
        <div class="file-name" id="pdf-fname"></div>
      </div>
      <div class="upload-card" id="excel-card">
        <input type="file" id="excel-file" accept=".xls,.xlsx,.csv" />
        <div class="icon">ğŸ“Š</div>
        <h3>Ù¾Ø±ÛŒÙ†Øª Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù†Ú©ÛŒ (Excel)</h3>
        <p>ÙØ§ÛŒÙ„ Excel ØµØ§Ø¯Ø± Ø´Ø¯Ù‡ Ø§Ø² Ø¨Ø§Ù†Ú© Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ú©Ø´ÛŒØ¯ ÛŒØ§ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</p>
        <span class="badge" id="excel-badge">Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡</span>
        <div class="file-name" id="excel-fname"></div>
      </div>
    </div>

    <div class="options-bar">
      <label title="ØªØ·Ø¨ÛŒÙ‚ Ø¨Ø± Ø§Ø³Ø§Ø³ Û´ Ø±Ù‚Ù… Ø¢Ø®Ø± Ú©Ø¯ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ø¨Ø§Ù†Ú©ÛŒ Ø¯Ø± Ø´Ø±Ø­ Ø³Ù†Ø¯">
        <input type="checkbox" id="opt-tracking" checked />
        ØªØ·Ø¨ÛŒÙ‚ Ø¨Ø§ Û´ Ø±Ù‚Ù… Ø¢Ø®Ø± Ú©Ø¯ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ
      </label>
      <div class="sep"></div>
      <label title="ØªØ·Ø¨ÛŒÙ‚ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø§Ù… ÙˆØ§Ø±ÛŒØ²Ú©Ù†Ù†Ø¯Ù‡">
        <input type="checkbox" id="opt-name" checked />
        ØªØ·Ø¨ÛŒÙ‚ Ø¨Ø§ Ù†Ø§Ù… ÙˆØ§Ø±ÛŒØ²Ú©Ù†Ù†Ø¯Ù‡
      </label>
      <div class="sep"></div>
      <label title="ÙÙ‚Ø· Ø³Ù†Ø¯Ù‡Ø§ÛŒ Ø¨Ø³ØªØ§Ù†Ú©Ø§Ø± Ù…Ø§Ù„ÛŒ (ÙˆØ§Ø±ÛŒØ²) â€” Ø¨Ø¯ÙˆÙ† Ø¨Ø¯Ù‡Ú©Ø§Ø±">
        <input type="checkbox" id="opt-credit-only" checked />
        ÙÙ‚Ø· Ø¨Ø³ØªØ§Ù†Ú©Ø§Ø± Ù…Ø§Ù„ÛŒ (ÙˆØ§Ø±ÛŒØ²)
      </label>
      <div class="sep"></div>
      <label title="ØªØ·Ø¨ÛŒÙ‚ Ú©Ù…Ú©ÛŒ Ø¨Ø§ Ù…Ø¨Ù„Øº">
        <input type="checkbox" id="opt-amount" checked />
        ØªØ·Ø¨ÛŒÙ‚ Ø¨Ø§ Ù…Ø¨Ù„Øº (Ú©Ù…Ú©ÛŒ)
      </label>
    </div>

    <div class="error-box" id="error-box"></div>

    <button class="btn-check" id="check-btn" disabled>
      <span>ğŸ”</span> Ø¨Ø±Ø±Ø³ÛŒ ÙÛŒØ´â€ŒÙ‡Ø§
    </button>

    <div id="loading">
      <div class="spinner"></div>
      <p id="loading-text">Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§...</p>
    </div>

    <div id="summary">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="num" id="s-total">0</div>
          <div class="lbl">Ú©Ù„ Ø³Ù†Ø¯Ù‡Ø§ÛŒ PDF</div>
        </div>
        <div class="stat-card green">
          <div class="num" id="s-found">0</div>
          <div class="lbl">Û±Û°Û°Ùª ØªØ·Ø¨ÛŒÙ‚ Ø¨Ø§ Ú©Ø¯ âœ…</div>
        </div>
        <div class="stat-card yellow">
          <div class="num" id="s-review">0</div>
          <div class="lbl">Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ø±Ø±Ø³ÛŒ (ÙÙ‚Ø· Ù†Ø§Ù…) âš ï¸</div>
        </div>
        <div class="stat-card purple">
          <div class="num" id="s-duplicate">0</div>
          <div class="lbl">ØªÚ©Ø±Ø§Ø±ÛŒ (Ù‚Ø¨Ù„Ø§Ù‹ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡) â›”</div>
        </div>
        <div class="stat-card red">
          <div class="num" id="s-notfound">0</div>
          <div class="lbl">Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯Ù‡ Ø¯Ø± Ø¨Ø§Ù†Ú© âŒ</div>
        </div>
        <div class="stat-card">
          <div class="num" id="s-bank">0</div>
          <div class="lbl">Ú©Ù„ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù†Ú©</div>
        </div>
      </div>
    </div>

    <div id="results">
      <div class="results-header">
        <h2>ğŸ“‹ Ú¯Ø²Ø§Ø±Ø´ ØªØ·Ø¨ÛŒÙ‚ ÙÛŒØ´â€ŒÙ‡Ø§</h2>
        <div class="filter-tabs">
          <button class="active" onclick="setFilter('all',this)">Ù‡Ù…Ù‡</button>
          <button onclick="setFilter('found',this)">Ù‚Ø·Ø¹ÛŒ Ø¨Ø§ Ú©Ø¯ âœ…</button>
          <button onclick="setFilter('review',this)">Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªÛŒ âš ï¸</button>
          <button onclick="setFilter('duplicate',this)">ØªÚ©Ø±Ø§Ø±ÛŒ â›”</button>
          <button onclick="setFilter('notfound',this)">Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯Ù‡ âŒ</button>
        </div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:38px">Ø±Ø¯ÛŒÙ</th>
              <th>ØªØ§Ø±ÛŒØ®</th>
              <th>Ø´Ù…Ø§Ø±Ù‡ Ø³Ù†Ø¯PDF</th>
              <th>Ù†ÙˆØ¹</th>
              <th>Ù…Ø¨Ù„Øº (Ø±ÛŒØ§Ù„)</th>
              <th>Ú©Ø¯ Û´ Ø±Ù‚Ù…ÛŒ / Ø´Ù†Ø§Ø³Ù‡</th>
              <th>Ù†Ø§Ù… ÙˆØ§Ø±ÛŒØ²Ú©Ù†Ù†Ø¯Ù‡ / Ø´Ø±Ø­</th>
              <th>ÙˆØ¶Ø¹ÛŒØª ØªØ·Ø¨ÛŒÙ‚</th>
              <th>Ø±Ø¯ÛŒÙ Ø§Ú©Ø³Ù„ Ø¨Ø§Ù†Ú©</th>
            </tr>
          </thead>
          <tbody id="result-body"></tbody>
        </table>
      </div>
      <div class="export-bar">
        <button class="btn-export" onclick="printReport()">ğŸ–¨ï¸ Ù¾Ø±ÛŒÙ†Øª Ú¯Ø²Ø§Ø±Ø´</button>
        <button class="btn-export" onclick="exportCSV()">ğŸ’¾ Ø¯Ø§Ù†Ù„ÙˆØ¯ CSV</button>
      </div>
    </div>

    <details id="log-section">
      <summary>ğŸ”¬ Ø¬Ø²Ø¦ÛŒØ§Øª Ù¾Ø±Ø¯Ø§Ø²Ø´ (Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ù‚ÛŒÙ‚)</summary>
      <div id="log-box"></div>
    </details>

  </div>

  <script>
    let pdfFile = null, excelFile = null, allResults = [];

    // â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function log(msg) {
      const b = document.getElementById('log-box');
      b.textContent += msg + '\n';
      document.getElementById('log-section').style.display = 'block';
    }
    function showError(msg) { const e = document.getElementById('error-box'); e.textContent = msg; e.style.display = 'block'; }
    function clearError() { document.getElementById('error-box').style.display = 'none'; }
    function updateBtn() { document.getElementById('check-btn').disabled = !(pdfFile && excelFile); }
    function fmtAmt(n) { return (n || n === 0) ? Number(n).toLocaleString('en-US') : 'â€”'; }

    document.getElementById('pdf-file').addEventListener('change', function () {
      pdfFile = this.files[0];
      if (pdfFile) {
        document.getElementById('pdf-card').classList.add('loaded');
        document.getElementById('pdf-badge').textContent = 'âœ… Ø¢Ù…Ø§Ø¯Ù‡';
        document.getElementById('pdf-fname').textContent = pdfFile.name;
      }
      updateBtn();
    });

    document.getElementById('excel-file').addEventListener('change', function () {
      excelFile = this.files[0];
      if (excelFile) {
        document.getElementById('excel-card').classList.add('loaded');
        document.getElementById('excel-badge').textContent = 'âœ… Ø¢Ù…Ø§Ø¯Ù‡';
        document.getElementById('excel-fname').textContent = excelFile.name;
      }
      updateBtn();
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MAIN BUTTON (Call Python Backend)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    document.getElementById('check-btn').addEventListener('click', async () => {
      clearError();
      document.getElementById('loading').style.display = 'block';
      document.getElementById('summary').style.display = 'none';
      document.getElementById('results').style.display = 'none';
      document.getElementById('log-box').textContent = '';
      document.getElementById('check-btn').disabled = true;
      document.getElementById('loading-text').textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ùˆ Ù¾Ø±Ø¯Ø§Ø²Ø´...';

      const useTracking = document.getElementById('opt-tracking').checked;
      const useName = document.getElementById('opt-name').checked;
      const useAmount = document.getElementById('opt-amount').checked;
      const creditOnly = document.getElementById('opt-credit-only').checked;

      const formData = new FormData();
      formData.append('pdf_file', pdfFile);
      formData.append('excel_file', excelFile);

      // Append options as strings
      formData.append('use_tracking', String(useTracking));
      formData.append('use_name', String(useName));
      formData.append('use_amount', String(useAmount));
      formData.append('credit_only', String(creditOnly));

      try {
        const response = await fetch('/analyze', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          let errorText = await response.text();
          try {
            const errJson = JSON.parse(errorText);
            if (errJson.detail) errorText = errJson.detail;
          } catch (e) { }
          throw new Error(errorText || response.statusText);
        }

        const data = await response.json();
        if (!data.ok) throw new Error("Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ Ø§Ø² Ø³Ø±ÙˆØ±");

        const results = data.results;
        allResults = results;

        log(`âœ… Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø³Ù…Øª Ø³Ø±ÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.`);
        log(`ğŸ“‹ Ú©Ù„ Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ÛŒ PDF: ${data.pdf_total}`);
        log(`ğŸ“Š Ú©Ù„ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù†Ú©: ${data.bank_total}`);
        if (data.debug) {
          log(`\nÙ†Ù…ÙˆÙ†Ù‡ Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ÛŒ PDF Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø´Ø¯Ù‡:`);
          data.debug.pdf_rows_sample.forEach(r => log(JSON.stringify(r)));
          log(`\nÙ†Ù…ÙˆÙ†Ù‡ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù†Ú© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø´Ø¯Ù‡:`);
          data.debug.bank_txns_sample.forEach(t => log(JSON.stringify(t)));
        }

        document.getElementById('s-total').textContent = results.length;
        document.getElementById('s-found').textContent = data.found;
        document.getElementById('s-review').textContent = data.review;
        document.getElementById('s-duplicate').textContent = data.duplicate || 0;
        document.getElementById('s-notfound').textContent = data.not_found;
        document.getElementById('s-bank').textContent = data.bank_total;

        renderTable(results);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('summary').style.display = 'block';
        document.getElementById('results').style.display = 'block';

      } catch (err) {
        document.getElementById('loading').style.display = 'none';
        showError('Ø®Ø·Ø§: ' + err.message);
        log('âŒ ' + (err.stack || err.message));
        console.error(err);
      }
      document.getElementById('check-btn').disabled = false;
    });

    function renderTable(results) {
      const tbody = document.getElementById('result-body');
      tbody.innerHTML = '';
      results.forEach((r, i) => {
        const tr = document.createElement('tr');
        tr.dataset.status = (r.status === 'exact') ? 'found' : (r.status === 'review') ? 'review' : (r.status === 'duplicate') ? 'duplicate' : 'notfound';
        const typeTag = r.doc_type === 'Ø¨Ø³ØªØ§Ù†Ú©Ø§Ø±'
          ? `<span class="col-type col-credit">â†‘ Ø¨Ø³ØªØ§Ù†Ú©Ø§Ø±</span>`
          : r.doc_type === 'Ø¨Ø¯Ù‡Ú©Ø§Ø±' ? `<span class="col-type col-debit">â†“ Ø¨Ø¯Ù‡Ú©Ø§Ø±</span>` : `<span class="col-type">â€”</span>`;

        let statusBadge = '';
        if (r.status === 'exact') statusBadge = `<span class="status-badge found" style="background:rgba(34,197,94,.1);color:#16a34a;border:1px solid rgba(34,197,94,.2)">âœ… Ù¾ÛŒØ¯Ø§ Ø´Ø¯ (Û±Û°Û°Ùª)</span>`;
        else if (r.status === 'review') statusBadge = `<span class="status-badge" style="color:#d97706;background:rgba(217,119,6,.12);border:1px solid rgba(217,119,6,.25);">âš ï¸ Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªÛŒ</span>`;
        else if (r.status === 'duplicate') statusBadge = `<span class="status-badge" style="color:#9333ea;background:rgba(147,51,234,.1);border:1px solid rgba(147,51,234,.25);">â›” ØªÚ©Ø±Ø§Ø±ÛŒ Ø¯Ø± Ø³ÛŒØ³ØªÙ…</span>`;
        else statusBadge = `<span class="status-badge notfound" style="background:rgba(220,38,38,.08);color:#dc2626;border:1px solid rgba(220,38,38,.2)">âŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯</span>`;

        const matched = (r.status === 'exact' || r.status === 'review') ? `<div class="match-type" style="margin-top:4px">${r.match_method}</div>` : '';
        const excelRow = (r.status === 'exact' || r.status === 'review') && r.bank_row ? `Ø±Ø¯ÛŒÙ ${r.bank_row}` : 'â€”';

        tr.innerHTML = `
      <td style="color:var(--text2);font-size:.75rem">${r.idx || i + 1}</td>
      <td>${r.date || 'â€”'}</td>
      <td class="tracking">${r.doc_num || 'â€”'}</td>
      <td>${typeTag}</td>
      <td class="amount">${fmtAmt(r.amount)}</td>
      <td class="tracking" style="color:#fbbf24">${r.codes || 'â€”'}</td>
      <td style="font-size:.8rem;max-width:200px">${r.sender || r.desc || 'â€”'}</td>
      <td>${statusBadge}${matched}</td>
      <td style="font-size:.85rem;font-weight:600;color:var(--text);text-align:center">${excelRow}</td>
    `;
        tbody.appendChild(tr);
      });
    }

    function setFilter(filter, btn) {
      document.querySelectorAll('.filter-tabs button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('#result-body tr').forEach(tr => {
        tr.style.display = (filter === 'all' || tr.dataset.status === filter) ? '' : 'none';
      });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // EXPORT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function printReport() {
      const w = window.open('', '_blank');
      w.document.write(`<!DOCTYPE html><html dir="rtl" lang="fa"><head>
    <meta charset="UTF-8"><title>Ú¯Ø²Ø§Ø±Ø´ ØªØ·Ø¨ÛŒÙ‚ ÙÛŒØ´</title>
    <style>body{font-family:Tahoma,sans-serif;direction:rtl;padding:20px}
    table{width:100%;border-collapse:collapse;font-size:11px}
    th,td{border:1px solid #ccc;padding:6px 8px;text-align:right}
    th{background:#f0f0f0;font-weight:bold}
    .found{color:green;font-weight:bold}.notfound{color:red;font-weight:bold}
    @media print{body{padding:0}}</style></head><body>
    <h2>Ú¯Ø²Ø§Ø±Ø´ ØªØ·Ø¨ÛŒÙ‚ ÙÛŒØ´â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù†Ú©ÛŒ</h2>
    <p>ØªØ§Ø±ÛŒØ®: ${new Date().toLocaleDateString('fa-IR')}</p>
    <table><thead><tr><th>#</th><th>ØªØ§Ø±ÛŒØ®</th><th>Ù†ÙˆØ¹</th><th>Ù…Ø¨Ù„Øº</th><th>Ú©Ø¯ Û´ Ø±Ù‚Ù…ÛŒ</th><th>Ù†Ø§Ù…</th><th>ÙˆØ¶Ø¹ÛŒØª</th><th>Ø±ÙˆØ´</th></tr></thead><tbody>
    ${allResults.map((r, i) => {
        let stColor = r.status === 'exact' ? 'green' : r.status === 'review' ? 'orange' : r.status === 'duplicate' ? 'purple' : 'red';
        let stText = r.status === 'exact' ? 'âœ… Ù¾ÛŒØ¯Ø§ Ø´Ø¯' : r.status === 'review' ? 'âš ï¸ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ø±Ø±Ø³ÛŒ' : r.status === 'duplicate' ? 'â›” Ø­Ø³Ø§Ø¨â€ŒØ´Ø¯Ù‡ (ØªÚ©Ø±Ø§Ø±ÛŒ)' : 'âŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯';
        return `<tr><td>${r.idx || i + 1}</td><td>${r.date || ''}</td><td>${r.doc_type || ''}</td>
    <td>${r.amount ? Number(r.amount).toLocaleString() : ''}</td>
    <td>${r.codes || ''}</td><td>${r.sender || ''}</td>
    <td style="color:${stColor};font-weight:bold">${stText}</td>
    <td>${r.match_method || ''}</td></tr>`
      }).join('')}
    </tbody></table>
    <script>window.onload=()=>window.print()<\/script></body></html>`);
      w.document.close();
    }

    function exportCSV() {
      const hdr = ['Ø±Ø¯ÛŒÙ', 'ØªØ§Ø±ÛŒØ®', 'Ø´Ù…Ø§Ø±Ù‡ Ø³Ù†Ø¯', 'Ù†ÙˆØ¹', 'Ù…Ø¨Ù„Øº', 'Ú©Ø¯ Û´ Ø±Ù‚Ù…ÛŒ', 'Ù†Ø§Ù…/Ø´Ø±Ø­', 'ÙˆØ¶Ø¹ÛŒØª', 'Ø±ÙˆØ´ ØªØ·Ø¨ÛŒÙ‚'];
      const data = allResults.map((r, i) => {
        const stText = r.status === 'exact' ? 'Ù¾ÛŒØ¯Ø§ Ø´Ø¯' : r.status === 'review' ? 'Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªÛŒ (Ù†Ø§Ù…)' : r.status === 'duplicate' ? 'ØªÚ©Ø±Ø§Ø±ÛŒ Ø­Ø³Ø§Ø¨ Ø´Ø¯Ù‡ Ø¯Ø± ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„' : 'Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯';
        return [
          r.idx || i + 1, r.date || '', r.doc_num || '', r.doc_type || '', r.amount || '', r.codes || '', r.sender || '',
          stText, r.match_method || ''
        ];
      });
      const csv = [hdr, ...data].map(row => row.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');
      const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
      a.download = 'receipt_report_' + Date.now() + '.csv'; a.click();
    }
  </script>
</body>

</html>